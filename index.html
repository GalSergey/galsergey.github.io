<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datapack Assembler by GalSergey</title>
    <link rel="icon" href="https://styles.redditmedia.com/t5_6aviyc/styles/profileIcon_msenduashsw81.jpg"
        type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.2.2/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #333;
            color: #fff;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            height: 100vh;
        }

        #myInput {
            font-family: 'Courier New', monospace;
            height: 90vh;
            display: block;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 5px;
            resize: none;
            position: sticky;
            top: 0;
            background-color: #444;
            border-bottom: 1px solid #000;
            font-size: 16px;
            padding: 10px;
            color: #fff;
        }

        #inputFields {
            display: flex;
            margin: 10px;
            align-items: center;
        }

        #archiveNameInput,
        #archiveName,
        #description,
        #descriptionInput,
        #dataFormatVersion,
        #dataFormatVersionInput {
            margin-right: 10px;
            color: #eee;
        }

        #myInput input,
        #archiveName input,
        #description input,
        #packFormatSelect select,
        #dataFormatVersion input {
            width: 260px;
            padding: 8px;
            box-sizing: border-box;
            background-color: #555;
            color: #fff;
            border: none;
        }

        #archiveName label,
        #description label,
        #dataFormatVersion label {
            font-weight: bold;
        }

        button {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.5s ease;
            padding: 10px;
            margin-left: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
        }

        button:hover {
            background-color: #39813c;
        }

        #footer {
            bottom: 0;
            align-self: stretch;
            background-color: #444;
            color: #eee;
            text-align: center;
            padding: 0px;
            font-size: 12px;
            line-height: 1;
        }

        #footer a {
            color: #61dafb;
            text-decoration: none;
            margin: 0 5px;
        }

        input:focus,
        textarea:focus {
            outline: 2px solid #000;
        }

        #resetButton {
            background-color: #ff0000;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px;
            margin-top: 5px;
            margin-left: 5px;
        }

        #Settings {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
        }

        #resetButton:hover {
            background-color: #b40000;
        }

        .tooltip {
            position: relative;
        }

        .tooltip::after {
            font-family: 'Courier New', monospace;
            content: attr(target-ver);
            white-space: nowrap;
            pointer-events: none;
            position: absolute;
            top: 60%;
            right: 38px;
            transform: translateY(-75%);
            font-size: 12px;
            color: #aaa;
            direction: ltr;
        }

        .share-button {
            background-color: #3498db;
        }

        .share-button:hover {
            background-color: #236694;
        }

        .container {
            display: flex;
            align-items: center;
        }

        input[id="copyLink"] {
            position: absolute;
            margin-top: 11.25px;
            margin-left: 70px;
            display: none;
            animation: fade-out 1s;
            animation: fade-in 1s;
        }

        @keyframes fade-in {
            from {
                transform: translate(-50%) scale(0%, 100%);
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fade-out {
            from {
                opacity: 1;
            }

            to {
                transform: translate(-50%) scale(0%, 100%);
            }
        }

        .container {
            display: flex;
            align-items: center;
        }

        .manual-input {
            display: none;
        }

        header {
            display: flex;
            padding: 10px;
            justify-content: space-between;
            align-items: center;
        }

        .icon,
        .skin,
        .glasses {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            transition: transform 0.3s ease-out;
        }

        .skin,
        .glasses {
            position: absolute;
        }

        .icon:hover .glasses {
            transform: translateY(15px);
        }

        .header-links {
            display: flex;
            gap: 20px;
        }

        .header-links a {
            text-decoration: none;
            color: #d00000;
            font-weight: bold;
        }

        .links {
            display: flex;
            flex-direction: row;
            align-items: center;
        }
    </style>
</head>

<body>
    <header>
        <div class="links">
            <div class="icon">
                <a href="/dev">
                    <img src="/assets/skin.png" class="skin">
                    <img src="/assets/glasses.png" class="glasses">
                </a>
            </div>
            <nav class="header-links">
                <a style="color: white">Datapack Assembler</a>
                <a href="/cba">Command Block Assembler</a>
                <a href="/item">Item Components Viewer</a>
            </nav>
        </div>
        <div class="library">
            <div id="exampleSelector">
                <label for="authorSelect">Author:</label>
                <select id="authorSelect"
                    style="display: inline-block; width: 128px; height: 31px; background: rgb(85, 85, 85); color: white; border-color: rgb(85, 85, 85); margin-right: 4px;"></select>
                <label for="exampleSelect">Select Example:</label>
                <select id="exampleSelect"
                    style="display: inline-block; width: 260px; height: 31px; background: rgb(85, 85, 85); color: white; border-color: rgb(85, 85, 85); margin-right: 4px;"></select>
                <button class="load-example" id="openExampleButton" onclick="loadExample(event)">Load Example</button>
            </div>
        </div>
    </header>
    <textarea spellcheck="false" id="myInput" name="myInput" placeholder="Enter the commands from the comment or drop the .zip archive with a datapack....
For example:
# function example:load
say Datapack loaded.

# function example:tick
give @a hugs"></textarea>
    <div id="Settings">
        <div id="inputFields">
            <div id="archiveName">
                <label for="archiveName">Name: </label>
                <input type="text" id="archiveNameInput" name="archiveName" value="Example Datapack Name">
            </div>

            <div id="description">
                <label for="description">Description: </label>
                <input type="text" id="descriptionInput" name="description" value="Example Description">
            </div>
            <div id="dataFormatVersion">
                <label for="dataFormatVersion">Pack format: </label>
                <input type="number" id="dataFormatVersionInput" name="dataFormatVersion" class="manual-input" min="4"
                    style="margin: 0px;">
                <span class="tooltip" id="tooltip" style="display: none;"></span>
                <select id="packFormatSelect" name="packFormatSelect"
                    style="display: inline-block; width: 260px; height: 31px; background: rgb(85, 85, 85); color: white; border-color: rgb(85, 85, 85); margin-right: 4px;"></select>
            </div>
            <div>
                <div>
                    <input type="checkbox" id="manualCheckbox">
                    <label for="manualCheckbox">Manual</label>
                </div>
            </div>
        </div>
        <div class="container">
            <div>
                <button onclick="createZipFile()">Assemble Datapack</button>
                <button id="resetButton" onclick="resetValues()">Reset to Default</button>
                <input type="text" id="copyLink" class="copyLink" value="http://far.ddns.me/?share=kiycXOKPwg" size="30"
                    readonly>
                <button class="share-button" onclick="sendShare(event)">Share</button>
            </div>
        </div>

    </div>
    <div id="footer">
        <p id="patreon"><a href="https://www.patreon.com/GalSergey" target="_blank">Patreon</a></p>
        <p>Please report any bugs on the site to<a href="https://www.reddit.com/user/GalSergey"
                target="_blank">GalSergey</a>|<a href="https://modrinth.com/user/GalSergey" target="_blank">My
                datapacks</a></p>
    </div>
    <script>

        const patreons = ['Someone', 'NatNATTO', 'Andrew', 'CadeMade'];
        const patreonsFormat = `${patreons.slice(0, -1).join(', ')} and ${patreons[patreons.length - 1]}`;
        console.log(`Thank you to ${patreonsFormat} for the support on https://patreon.com/GalSergey`);
        const ThanksPatreons = document.getElementById('patreon');
        ThanksPatreons.innerHTML = `Thank you ${patreonsFormat} for your support on<a href="https://www.patreon.com/GalSergey" target="_blank">Patreon</a>`;

        var versionMap = [];
        var lastRelease = 4;
        var lastSnapshot = 4;
        targetVersion = lastRelease;

        function getHash(hash) {
            let hashes;
            try {
                hashes = JSON.parse(localStorage['hashes']);
            } catch {
                localStorage['hashes'] = '{}';
                hashes = {};
            }
            return hashes[hash];
        }

        function setHash(hash, link) {
            let hashes;
            try {
                hashes = JSON.parse(localStorage['hashes']);
            } catch {
                localStorage['hashes'] = '{}';
                hashes = {};
            }
            hashes[hash] = link;
            localStorage['hashes'] = JSON.stringify(hashes);
        }

        const maskMappings = {
            'advancement': 'advancements',
            'banner_pattern_tag': 'tags/banner_pattern',
            'banner_pattern': 'banner_pattern',
            'block_tag': 'tags/blocks',
            'cat_variant_tag': 'tags/cat_variant',
            'chat_type': 'chat_type',
            'damage_type_tag': 'tags/damage_type',
            'damage_type': 'damage_type',
            'dimension_type': 'dimension_type',
            'dimension': 'dimension',
            'enchantment_provider': 'enchantment_provider',
            'enchantment_tag': 'tags/enchantment',
            'enchantment': 'enchantment',
            'entity_type_tag': 'tags/entity_types',
            'fluid_tag': 'tags/fluids',
            'function_tag': 'tags/functions',
            'function': 'functions',
            'game_event_tag': 'tags/game_events',
            'instrument_tag': 'tags/instrument',
            'instrument': 'instrument',
            'item_modifier': 'item_modifiers',
            'item_tag': 'tags/items',
            'jukebox_song': 'jukebox_song',
            'loot_table': 'loot_tables',
            'mob_effect_tag': 'tags/mob_effect',
            'painting_variant_tag': 'tags/painting_variant',
            'painting_variant': 'painting_variant',
            'pig_variant': 'pig_variant',
            'point_of_interest_type_tag': 'tags/point_of_interest_type',
            'predicate': 'predicates',
            'recipe': 'recipes',
            'structure_tag': 'tags/worldgen/structure',
            'structure': 'structures',
            'test_environment': 'test_environment',
            'test_instance': 'test_instance',
            'trial_spawner': 'trial_spawner',
            'trim_material': 'trim_material',
            'trim_pattern': 'trim_pattern',
            'wolf_variant': 'wolf_variant',
            'worldgen_tag': 'tags/worldgen',
            'worldgen': 'worldgen'
        };

        function maskConvert(mask, reverse = false) {
            var mappings = maskMappings;
            if (targetVersion >= 45) {
                mappings = Object.entries(mappings).reduce((acc, [key, value]) => {
                    acc[key] = value.endsWith('s') ? value.slice(0, -1) : value;
                    return acc;
                }, {})
            }
            return reverse ? Object.keys(mappings).find(key => mappings[key] === mask) : mappings[mask];
        }

        var examplesByCategory = {
            'Empty': ['Empty']
        };

        async function genMap() {
            const response = await fetch('https://raw.githubusercontent.com/misode/mcmeta/summary/versions/data.min.json');
            const data = await response.json();

            data.forEach(version => {
                versionMap.push({
                    pack: version.data_pack_version,
                    id: version.id,
                    name: version.name,
                    type: version.type
                })
            });

            versionMap.all = versionMap.reduce((prev, curr) => {
                let pack = curr.pack;
                let currPack = prev[pack];
                if (!currPack) {
                    currPack = { ids: [], text: '' };
                }
                currPack.ids.push(curr.id);
                currPack.text = currPack.ids.length > 1 ? `${currPack.ids[currPack.ids.length - 1]} - ${currPack.ids[0]}` : currPack.ids[0];
                prev[pack] = currPack;
                return prev;
            }, {});

            lastRelease = versionMap.find((version, index) => {
                return version.type === "release";
            });
            lastSnapshot = versionMap.find((version, index) => {
                return version.type === "snapshot";
            });

            versionMap.releases = versionMap.reduce((prev, curr, index) => {
                if (curr.type === "release" || (index === 0 && curr.pack === lastSnapshot.pack)) {
                    let pack = curr.pack;
                    let currPack = prev[pack];
                    if (!currPack) {
                        currPack = { ids: [], pack: 0, text: '' };
                    }
                    currPack.ids.push(curr.name);
                    currPack.pack = pack;
                    let tip = pack === lastSnapshot.pack || pack === lastRelease.pack ? ` (last ${curr.type})` : '';
                    currPack.text = currPack.ids.length > 1 ? `${currPack.ids[currPack.ids.length - 1]} - ${currPack.ids[0]}${tip}` : `${currPack.ids[0]}${tip}`;
                    prev[pack] = currPack;
                }
                return prev;
            }, {});
        };

        document.addEventListener("DOMContentLoaded", async function () {
            if (versionMap.length === 0) await genMap();
            targetVersion = lastRelease.pack;

            document.getElementById('dataFormatVersionInput').value = targetVersion;
            const urlParams = new URLSearchParams(window.location.search);
            const categoryFromURL = urlParams.get('category');
            const exampleFromURL = urlParams.get('example');
            const shareFromURL = urlParams.get('share');

            if (categoryFromURL && exampleFromURL) {
                loadExample(event = event.NONE, categoryFromURL.replace(/_/g, ' '), exampleFromURL.replace(/_/g, ' '));
            } else if (shareFromURL) {
                loadShare(shareFromURL);
            };
            const newUrl = window.location.href.split('?')[0];
            window.history.pushState({}, document.title, newUrl);
            const categories = Object.keys(examplesByCategory);
            const authorSelect = document.getElementById('authorSelect');
            authorSelect.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.text = category;
                authorSelect.add(option);
            });
            authorSelect.addEventListener('change', update_Examples);

            document.addEventListener('drop', function (event) {
                event.preventDefault();
                var file = event.dataTransfer.files[0];
                if (file) unzipDatapack(file);
            });

            document.addEventListener('dragover', function (event) {
                event.preventDefault();
            });

            document.getElementById("copyLink").addEventListener("click", selectText);

            const manualCheckbox = document.getElementById('manualCheckbox');
            const manualInputContainer = document.getElementById('manualInputContainer');
            const dataFormatVersionInput = document.getElementById('dataFormatVersionInput');
            const packFormatSelect = document.getElementById('packFormatSelect');
            Object.values(versionMap.releases).reverse().forEach(version => {
                const option = document.createElement('option');
                option.value = version.pack;
                option.text = version.text;
                packFormatSelect.appendChild(option);
            });

            const option = document.createElement('option');
            option.value = "0";
            option.text = "Custom";
            option.disabled = true;
            packFormatSelect.appendChild(option);
            packFormatSelect.value = targetVersion;
            manualCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    packFormatSelect.style.display = 'none';
                    dataFormatVersionInput.style.display = 'inline-block';
                    tooltip.style.display = 'inline-block';
                } else {
                    packFormatSelect.style.display = 'inline-block';
                    dataFormatVersionInput.style.display = 'none';
                    tooltip.style.display = 'none';
                }
            });

            packFormatSelect.addEventListener('change', function (event) {
                targetVersion = packFormatSelect.value;
                document.getElementById('dataFormatVersionInput').value = targetVersion;
            });
        });

        var fail = false;
        function createZipFile() {
            fail = false;
            if (['44', '43'].includes(targetVersion.toString())) {
                alert("This version is not supported.")
                fail = true;
                return;
            }
            var userInput = document.getElementById("myInput").value;
            var description = document.getElementById("descriptionInput").value;
            var archiveName = document.getElementById("archiveNameInput").value;
            if (!userInput.trim() || !description.trim() || !archiveName.trim()) {
                alert("Please, fill in all fields.");
                return;
            }

            var zip = new JSZip();
            var lines = userInput.split('\n');
            var currentPath = '';
            var currentContent = '';
            var currentExtension = '.json';

            function addFile(path, content, extension) {
                content = content.replace(/\n+$/, '');
                zip.file(path + extension, content);
            }

            function addLoadTickFile() {
                const defaultNamespace = 'minecraft';
                const functionFolder = maskConvert('function');
                const loadTickFilename = currentPath.endsWith('load') ? 'load' : 'tick';
                const loadTickPath = `data/${defaultNamespace}/tags/${functionFolder}/${loadTickFilename}.json`;
                // var loadTickPath = 'data/' + loadTickNamespace + '/tags/functions/' + loadTickFilename + '.json';
                var loadTickContent = {
                    values: [currentPath.replace('data/', '').replace('.mcfunction', '').replace(/\/functions?\//, ':').replace('.json', '')]
                };
                zip.file(loadTickPath, JSON.stringify(loadTickContent, null, 4));
            }

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                if (line.startsWith('#') && !line.startsWith('#:')) {
                    var parts = line.substring(1).trim().split(' ');
                    if (parts.length !== 2) {
                        currentContent += `${line}\n`;
                        continue;
                    }
                    var maskName = parts[0];
                    var functionParams = parts[1].split(':');

                    if (!(parts.length === 2 && maskConvert(maskName))) {
                        currentContent += `${line}\n`;
                        continue;
                    }

                    if (currentPath && currentContent) {
                        addFile(currentPath, currentContent, currentExtension);
                    }

                    currentPath = '';
                    currentExtension = '.json';
                    currentContent = '';

                    if (functionParams.length === 2) {
                        var namespace = functionParams[0];
                        var filename = functionParams[1];
                        var maskName2 = maskConvert(maskName);

                        if (maskName === 'function') {
                            currentExtension = '.mcfunction';
                        }

                        currentPath = `data/${namespace}/${maskName2}/${filename}`;
                        if (['load', 'tick'].includes(filename)) {
                            addLoadTickFile();
                        }
                    }
                } else if (!line.startsWith('#:')) {
                    currentContent += `${line}\n`;
                }
            }

            if (currentPath && currentContent) {
                addFile(currentPath, currentContent, currentExtension);
            }

            zip.file('pack.mcmeta',
                `{
    "__comment": "The datapack is assembled by Datapack Assembler",
    "__link": "${window.location.origin}",
    "__patreon": "Thank you to ${patreonsFormat} for the support on https://patreon.com/GalSergey",

    "pack": {
        "description": "${description}",
        "pack_format": ${targetVersion}
    }
}`);
            if (fail) return;
            zip.generateAsync({ type: "blob", compression: "DEFLATE" })
                .then(function (blob) {
                    var a = document.createElement("a");
                    a.href = window.URL.createObjectURL(blob);
                    a.download = `${archiveName}.zip`;
                    document.body.appendChild(a);

                    a.click();

                    document.body.removeChild(a);
                });
        }

        function setStorage(key, value) {
            let localData = JSON.parse(localStorage.getItem('datapacks')) || {};
            localData[key] = value;
            localStorage.setItem("datapacks", JSON.stringify(localData));
        }

        function getStorage(key) {
            let localData = JSON.parse(localStorage.getItem('datapacks')) || {};
            return localData[key] || null;
        }

        const textarea = document.getElementById('myInput');
        const inputFields = document.querySelectorAll('input, textarea');
        inputFields.forEach((inputField) => {
            inputField.addEventListener('input', handleInputChange);
            const storedValue = getStorage(inputField.id);
            if (storedValue !== null) {
                inputField.value = storedValue;
            }
        });
        textarea.value = getStorage('myInput');

        function resetValues() {
            if (confirm("Are you sure you want to reset to default values?")) {
                var copyLink = document.querySelector(".copyLink");
                copyLink.style.display = 'none';
                targetVersion = lastRelease.pack;
                const inputFields = document.querySelectorAll('input, textarea, select');
                inputFields.forEach((inputField) => {
                    if (/exampleSelect|authorSelect/.test(inputField.id)) return;
                    inputField.value = inputField.defaultValue;
                    if (["packFormatSelect", "dataFormatVersionInput"].includes(inputField.id)) {
                        inputField.value = targetVersion;
                    }
                    localStorage.setItem("datapacks", '{}');
                    setStorage(inputField.id || inputField.name, inputField.defaultValue);
                });
                versionUpdate(targetVersion);
            }
        }

        function handleInputChange(event) {
            document.querySelector(".copyLink").style.display = "none"
            const inputField = event.target;
            const inputId = inputField.id || inputField.name;
            const inputValue = inputField.value;

            if (inputValue.trim().startsWith('#$DA ')) {
                processSpecialLine(inputValue);
                inputField.value = inputField.value.replace(/^.*\n/, '');
            } else {
                if (event.target.id === "dataFormatVersionInput" && inputValue) {
                    targetVersion = inputValue;
                    const formatSelect = document.getElementById('packFormatSelect')
                    formatSelect.value = inputValue;
                    if (!formatSelect.value)
                        formatSelect.value = 0;
                }
                versionUpdate(targetVersion);
                setStorage(inputId, inputValue);
            }
        }

        function processSpecialLine(line) {
            const match = line.match(/Name:"([^"]*)", Description:"([^"]*)", PackFormat:"(\d+)"/);
            if (match) {
                const [, name, description, packFormat] = match;
                document.getElementById('archiveNameInput').value = name;
                document.getElementById('descriptionInput').value = description;
                versionUpdate(packFormat);
                setStorage('archiveName', name);
                setStorage('description', description);
                setStorage('dataFormatVersionInput', packFormat);
            }
        }

        async function tooltipUpdate() {
            if (versionMap.length === 0) {
                await genMap();
            }

            let tooltip = document.querySelector('.tooltip');
            tooltip.setAttribute('target-ver', versionMap.all[targetVersion]?.text || 'MissingNo.');
        }

        function selectText(event) {
            var copyLink = document.getElementById("copyLink");
            var link = copyLink.value.replace(/ /g, '_')
            if (event.shiftKey) {
                link = `You can use [Datapack Assembler](${link}) to get an example datapack.`
            } else if (event.ctrlKey) {
                const text = document.getElementById("myInput").value.split('\n').join('\n    ');
                link = `\n\n    ${text}\n\nYou can use [Datapack Assembler](${link}) to get an example datapack.`
            }

            const clipboard = new ClipboardJS('.copyLink', {
                text: function () {
                    return link;
                }
            });
            setTimeout(function () {
                copyLink.select();
            }, 100);
        }

        function update_Examples() {
            const selectedCategory = document.getElementById('authorSelect').value;
            const examples = examplesByCategory[selectedCategory];

            const exampleSelect = document.getElementById('exampleSelect');
            exampleSelect.innerHTML = '';
            const recent = Date.now() - 31 * 24 * 60 * 60 * 1000;

            Object.keys(examples).forEach((example) => {
                const option = document.createElement('option');
                option.text = `${examples[example].name} ${examples[example].date > recent ? '[NEW]' : ''}`;
                option.value = example;
                exampleSelect.add(option);
            })
        }

        async function loadExample(event, category, example) {
            example = document.getElementById('exampleSelect').value.replace(/ /g, '_');
            const shareLink = `${window.location.origin}/?share=${example}`;
            if (event.shiftKey) {
                const category = document.getElementById('authorSelect').value.replace(/ /g, '_');

                const clipboard = new ClipboardJS('.load-example', {
                    text: function () {
                        return shareLink;
                    }
                });
            } else {
                if (document.getElementById("myInput").value) {
                    var isConfirmed = confirm("You are sure you want to open an example? The entered data will be replaced.");
                    if (!isConfirmed) return false;
                };
                window.location.href = shareLink;
            };
            inputFields.forEach((inputField) => {
                setStorage(inputField.id, inputField.value);
            });
        };

        function update_authorSelect() {
            const categories = Object.keys(examplesByCategory).reverse();
            const authorSelect = document.getElementById('authorSelect');

            authorSelect.innerHTML = '';

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.text = category;
                authorSelect.add(option);
            });
        };

        fetch(`/get/library`)
            .then(response => response.json())
            .then(data => {
                examplesByCategory = data.datapacks;
                update_authorSelect();
                update_Examples();
            })
            .catch(error => console.error('Error loading example:', error));

        function unzipDatapack(file) {
            document.getElementById('archiveNameInput').value = file.name.replace('.zip', '');
            const reader = new FileReader();
            reader.onload = function (e) {
                JSZip.loadAsync(e.target.result).then(function (zip) {
                    const fileContents = {};
                    const promises = [];
                    zip.forEach((relativePath, zipEntry) => {
                        const promise = zipEntry.async('string').then(function (content) {
                            if (zipEntry.dir || zipEntry.name.includes('__MACOSX') || zipEntry.name.includes('.DS_Store')) return
                            fileContents[relativePath] = content;
                        });
                        promises.push(promise);
                    });
                    Promise.all(promises).then(function () {
                        loadDatapack(fileContents);
                    });
                }).catch(function (err) {
                    console.error("Failed to unzip file: ", err);
                });
            };
            reader.readAsArrayBuffer(file);
        }

        function readMcmeta(mcmeta) {
            try {
                const pack_mcmeta = JSON.parse(mcmeta).pack
                document.getElementById('descriptionInput').value = pack_mcmeta.description;
                versionUpdate(pack_mcmeta.pack_format);
            } catch (error) {
                console.error("Error reading pack.mcmeta file:", error);
                alert("Error reading pack.mcmeta file.");
                has_mcmeta = false;
            }
        }

        function versionUpdate(version) {
            targetVersion = version.toString();
            document.getElementById('dataFormatVersionInput').value = version;
            document.getElementById('packFormatSelect').value = version;
            tooltipUpdate();
        }

        function loadDatapack(fileContents) {
            var text = '';
            const regex = /^data\/minecraft\/tags\/function(s?)\/(load|tick)\.json$/;
            const has_mcmeta = Object.keys(fileContents).some((key) => {
                if (key === 'pack.mcmeta') {
                    readMcmeta(fileContents[key]);
                    delete fileContents[key];
                    return true;
                }
                if (key.split('/').includes('pack.mcmeta')) {
                    alert('Invalid archive with datapack detected.\nDatapack should not contain subfolders!\n\nTrying to delete extra folder(s)...')
                    const mask = key.replace('pack.mcmeta', '');
                    fileContents = Object.entries(fileContents).reduce((acc, [key, value]) => {
                        acc[key.replace(mask, '')] = value;
                        return acc;
                    }, {});
                    readMcmeta(fileContents['pack.mcmeta']);
                    delete fileContents['pack.mcmeta'];
                    return true;
                }
            })

            if (!has_mcmeta) {
                alert("This archive is missing pack.mcmeta!\nThe archive cannot be read.")
                return;
            }

            // console.log(Object.keys(fileContents))

            let files = Object.keys(fileContents);
            files.sort((a, b) => {
                // Первое правило: 'load.mcfunction' должен быть первым
                if (a.endsWith('load.mcfunction')) return -1;
                if (b.endsWith('load.mcfunction')) return 1;

                // Второе правило: 'tick.mcfunction' должен быть вторым
                if (a.endsWith('tick.mcfunction')) return -1;
                if (b.endsWith('tick.mcfunction')) return 1;

                // Третье правило: элементы, содержащие '/function/'
                if (a.includes('/function/') && !b.includes('/function/')) return -1;
                if (!a.includes('/function/') && b.includes('/function/')) return 1;

                // Четвертое правило: элементы, содержащие '/advancement/'
                if (a.includes('/advancement/') && !b.includes('/advancement/')) return -1;
                if (!a.includes('/advancement/') && b.includes('/advancement/')) return 1;

                // Если ничего из вышеуказанного не применимо, оставляем порядок как есть
                return 0;
            });

            // Создание нового объекта с отсортированными ключами
            let sortedFileContents = {};
            files.forEach(key => {
                sortedFileContents[key] = fileContents[key];
            });

            // Замена старого объекта новым
            fileContents = sortedFileContents;



            Object.keys(fileContents).forEach((file) => {
                const path_parts = file.split('/').splice(1);
                const namespace = path_parts.shift();
                const file_type = path_parts[0] === 'tags' ? path_parts.splice(0, 2).join('/') : path_parts.shift();
                const resourse = path_parts.join('/').split('.')[0];

                if (!maskConvert(file_type, true)) return
                if (namespace === 'minecraft' && maskConvert(file_type, true) === 'function_tag' && ['tick', 'load'].includes(resourse)) {
                    return;
                };
                text += `# ${maskConvert(file_type, true)} ${namespace}:${resourse}\n${fileContents[file].replace(/\n+$/, '')}\n\n`;
            })
            document.getElementById('myInput').value = text.replace(/\n+$/, '');
            inputFields.forEach((inputField) => {
                setStorage(inputField.id, inputField.value);
            });
        };

        var awaitLink = false;
        async function sendShare(event) {
            var shareButton = document.querySelector('.share-button');
            var copyLink = document.querySelector(".copyLink");

            if (awaitLink) return;
            var name = document.getElementById("archiveNameInput").value;
            var desc = document.getElementById("descriptionInput").value;
            var pack = document.getElementById("dataFormatVersionInput").value;
            var text = document.getElementById("myInput").value;
            if (!text || !name || !desc || !pack) {
                alert("Please fill in all fields.");
                return;
            }
            awaitLink = true;
            shareButton.style.cursor = "wait";

            const fullExample = `#$DA Name:"${name}", Description:"${desc}", PackFormat:"${pack}"\n${text}`;
            const hash = CryptoJS.SHA1(fullExample.replace(/\r/g, '')).toString();
            if (!getHash(hash)) {
                await fetch(`${window.location.origin}/share/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: fullExample }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.share)
                            setHash(hash, `${window.location.origin}/?share=${data.share}`);
                    })
                    .catch(error => {
                        console.error('Error creating paste:', error);
                    });
            }
            copyLink.value = getHash(hash) ? getHash(hash) : "Server error, try again later";
            copyLink.style.display = "initial";
            copyLink.addEventListener("animationstart", function (e) {
                // console.log("animationstart", e)
                if (e.animationName === "fade-in") {
                    e.target.classList.add("did-fade-in");
                }
            })
            shareButton.style.cursor = "pointer";
            awaitLink = false;
        }


        function loadShare(share) {
            fetch(`${window.location.origin}/share/get`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fileID: share,
                })
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById("myInput").value = data.content;
                    handleInputChange({ target: document.getElementById('myInput') });
                    inputFields.forEach((inputField) => {
                        setStorage(inputField.id, inputField.value);
                    });
                    const hash = CryptoJS.SHA1(data.content.replace(/\r/g, '')).toString();
                    setHash(hash, `${window.location.origin}/?share=${share}`);
                })
                .catch(error => {
                    console.error('Ошибка при загрузке пасты: ', error);
                });
        }

        function log(...msg) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}]`, ...msg)
        }
    </script>
</body>

</html>
